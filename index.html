<!DOCTYPE html>
<html>
<head>
	<title>Pointerest</title>
	<style>
		* {
			margin: 0;
			padding: 0;
		}
		html, body {
			height: 100%;
		}
		body {
			background: url('./assets/demo.jpg') no-repeat;
		}
		.container {
			width: 1028px;
			height: 975px;
			background: url('./assets/dashboard.jpg') no-repeat;
			margin: 60px 0 0 185px;
		}
		.pointerest .point {
			position: absolute;
			cursor: pointer;
			border-radius: 50%;
		}
		
		.pointerest .point .line {
			display: block;
			width: 0;
			position: absolute;
			top: 50%;
		}
		.pointerest .point.left .line {
			right: 100%;
		}
		.pointerest .point.right .line {
			left: 100%;
		}

		.pointerest .point .content {
			position: absolute;
			top: 50%;
			font-family: Open Sans, Helvetica Neue;
			width: 120px;
			color: white;
			font-size: 14px;
			display: none;
			padding: 10px 15px;
			border-radius: 5px;
		}
	</style>
</head>
<body>

	<div class="container">
		<span class="point left" data-x="280" data-y="200" data-color="red" data-content="Keep your house warm and your wallet full"></span>
		<span class="point" data-x="550" data-y="200" data-color="#888" data-content="A better understanding of water consumption"></span>
		<span class="point" data-x="820" data-y="200" data-content="Save energy and money"></span>
		<span class="point" data-x="900" data-y="910" data-content="Pay whenever you are ready"></span>
		<span class="point" data-x="750" data-y="350" data-content="Shows you if you have saved or should do better"></span>
		<span class="point" data-x="850" data-y="530" data-content="Hourly, daily, and monthly reporting"></span>
	</div>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script>
		(function(){

			var Pointerest = function(wrapper, arg1, arg2) {
				this.wrapper = wrapper;

				var arg1Type = Object.prototype.toString.call( arg1 ),
					arg2Type = Object.prototype.toString.call( arg2 );

				// first argument are options
				if( arg1Type === "[object Object]" ) {
					// extend user options
					jQuery.extend(this.options, arg1);
				}
				// second argument are options
				else if( arg2Type === "[object Object]" ) {
					jQuery.extend(this.options, arg2);	
				}

				if( arg1Type === "[object Array]" ) {
					this.pointNodes = arg1;
				}

				// initialize elements
				this.init();
			};

			Pointerest.prototype = {
				options: {
					animationSpeed: 300,
					radius: 10,
					color: "blue",
					lineHeight: 2,
					direction: null,
					margin: {
						top: 0,
						right: 20,
						bottom: 0,
						left: 20
					}
				},
				init: function() {
					this.setupWrapper();
					this.setupNodes();
				},
				setupWrapper: function() {

					this.wrapper.addClass("pointerest");

					this.wrapper.css({
						'position': 'relative'
					});
					this.wrapperWidth = this.wrapper.innerWidth();
					this.wrapperHeight = this.wrapper.innerHeight();
				},
				setupNodes: function() {
					var _this = this;

					// user has given the points as array
					if( this.pointNodes.length ) {
						this.createNodes();
					}
					this.pointNodes = [];

					this.wrapper.find('.point').each(function(node){

						var element = $(this),
							x = element.data("x") ? element.data("x") : 0,
							y = element.data("y") ? element.data("y") : 0,
							color = element.data("color") ? element.data("color") : _this.options.color,
							radius = element.data("radius") ? element.data("radius") * 2 : _this.options.radius * 2,
							direction = element.data("direction");

						var node = {
							element: element,
							x: x,
							y: y,
							radius: radius,
							color: color,
							direction: direction
						};

						node.direction = _this.getDirection(node);

						_this.pointNodes.push(node);

					});

					this.positionNodes();
					this.createChildrenElements();
					this.bindEvents();

				},
				positionNodes: function() {

					this.pointNodes.forEach(function(node){

						node.element.addClass(node.direction);
						node.element.css({
							'background': node.color,
							'width': node.radius,
							'height': node.radius,
							'top': node.y,
							'left': node.x,
						});

					});

				},
				getDirection: function(node) {

					// element direction preceeds all
					if( node.direction ) {
						return node.direction;
					}
					else if( node.element.hasClass("left") ) {
						return "left";
					}
					else if( node.element.hasClass("right") ) {
						return "right";
					}
					// user sets direction for all elements
					else if( this.options.direction ) {
						return this.options.direction;
					}
					// base it on the closest end
					else {
						return (node.x <= this.wrapperWidth / 2) ? 'left' : 'right';
					}
				},
				getLineWidth: function(node) {

					var width = 0;

					switch( node.direction ) {
						case "left":
							width = node.x + this.options.margin.left;
							break;
						case "right":
							width = this.wrapperWidth - node.x - this.options.radius * 2 + this.options.margin.right;
							break;
					}

					return width;
				},
				getContentPosition: function(node) {

					var x = 0;

					switch( node.direction ) {
						case "left":
							x = - this.getLineWidth(node) - node.content.outerWidth();
							break;
						case "right":
							x = this.getLineWidth(node) + this.options.margin.right;
							break;
					}

					return {
							'margin-top': - node.content.outerHeight() / 2,
							'left': x
						};
				},
				createNodes: function() {
					this.pointNodes.forEach(function(node){

						var htmlElement = $("<span>", {"class": "point"});
						
						htmlElement.data("x", node.x);
						htmlElement.data("y", node.y);
						htmlElement.data("content", node.content);
						htmlElement.data("color", node.color);
						htmlElement.data("radius", node.radius);
						htmlElement.data("direction", node.direction);

						this.wrapper.append(htmlElement);

					}.bind(this));
				},
				createChildrenElements: function() {

					var _this = this;

					this.pointNodes.forEach(function(node, index){

						var line = $("<span>", {"class": "line"}),
							content = $("<span>", {"class": "content"});

						// Create the line for the point
						node.element.append( line );
						node.line = line;
						line.css({
							'height': _this.options.lineHeight,
							'margin-top': - _this.options.lineHeight / 2,
							'background': node.color
						});

						// Create the content for the node
						node.element.append( content );
						node.content = content;
						content.html( node.element.data("content") );

						// The content takes the point's color
						content.css({
							'background-color': node.color
						});

						// positioning of the content
						content.css( _this.getContentPosition(node) );

					});

				},
				bindEvents: function() {

					var _this = this;

					this.pointNodes.forEach(function(node){

						var lineWidth = _this.getLineWidth(node);

						node.element.on("mouseenter", function(){

							// Avoid being under another point
							node.element.css({
								'z-index': _this.pointNodes.length + 1,
							});

							// Show the line and after that the content
							node.line.stop().animate({
								'width': lineWidth,
							}, _this.options.animationSpeed, function(){
								node.content.stop().fadeIn(_this.options.animationSpeed);
							});

						}).on("mouseleave", function(){
							
							// Hide the content first and then the line
							node.content.stop().fadeOut(_this.options.animationSpeed / 2, function(){
								node.line.stop().animate({
									'width': 0
								}, _this.options.animationSpeed / 2, function(){
									// Set the default z-index back
									node.element.css({
										'z-index': ''
									});
								});
							});
						});

					});

				},
				destroy: function() {
					// TODO: better removal of elements
					this.wrapper.find(".point").remove();
					this.wrapper.css({
						'position': ''
					});
					this.wrapper.removeClass("pointerest");
				}
			};

			// Register plugin for jQuery
			$.fn.Pointerest = function(arg1, arg2) {
				return new Pointerest(this, arg1, arg2);
			};

			var newNodes = [
				{
					color: "red",
					x: 200,
					y: 100,
					content: "This is the content"
				},
				{
					color: "green",
					content: "Here we are doing something",
					x: 300,
					direction: "right"
				}
			];
			$(".container").Pointerest(newNodes, {
				color: "#333",
				direction: "right"
			});

		})();
	</script>
</body>
</html>